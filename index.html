<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Potencia Ã“ptica</title>
    <style>
        body {
            background-color: #000;
            font-family: monospace;
            font-size: 1.1rem;
            color: #0f0;
            padding: 20px;
            text-align: center;
        }

        h2 {
            margin-bottom: 10px;
        }

        .metadata {
            margin-bottom: 20px;
        }

        table {
            margin: auto;
            border-collapse: collapse;
            color: #0f0;
        }

        th, td {
            border: 1px solid #0f0;
            padding: 12px;
            min-width: 60px;
            font-size: 1rem;
        }

        th {
            background-color: #111;
        }

        .ok {
            background-color: #0f0;
            color: #000;
        }

        .warn {
            background-color: #ff0;
            color: #000;
        }

        .low {
            background-color: #f00;
            color: #fff;
        }

        .empty {
            background-color: #333;
            color: #888;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #111;
            border: 2px solid #0f0;
            padding: 20px;
            color: #0f0;
            max-width: 90%;
            width: 90%;
            position: relative;
            font-size: 1.2rem;
            line-height: 1.5;
        }

        .modal-content p {
            font-size: 1.3rem;
            margin: 8px 0;
        }

        .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            color: #0f0;
            font-size: 20px;
            cursor: pointer;
        }

        .in-telegram th, .in-telegram td, .in-telegram .modal-content {
            font-size: 1.2rem;
        }

        .in-telegram .modal-content p {
            font-size: 1.4rem;
        }
    </style>
</head>
<body>

<h2 id="table-title">Terminal</h2>
<div class="metadata" id="test-info"></div>

<table id="potencia-table">
    <thead>
        <tr id="column-header">
            <th></th>
        </tr>
    </thead>
    <tbody>
        <tr id="potencia-row">
            <td><strong>â€”</strong></td>
        </tr>
    </tbody>
</table>

<div id="info-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('info-modal').style.display='none'">&times;</span>
        <h3>Detalles del Par</h3>
        <div id="modal-body"></div>
    </div>
</div>

<script>
    // Detect Telegram Mini App
    if (window.Telegram && Telegram.WebApp) {
        document.body.classList.add('in-telegram');
    }

    // Sample JSON for standalone test
    let matrixData = `{
        "Respuesta":{
      "tipoPrueba":"porTerminal",
      "fechaInicio":"2025-04-08 12:24:10",
      "fechaFin":"2025-04-08 12:25:02",
      "terminal":"BUR0036FOA8",
      "cantidadPares":8,
      "puertoPON":"BCNHGOR02118BUR0036F",
      "par57":{
         "telefono":"6865524574",
         "estadoOperativo":"Up",
         "estadoAdministrativo":"Up",
         "potenciaOptica":-22.359999999999999,
         "clasificacionPotencia":"Buena recepcion",
         "vlan":"1759",
         "serieModem":"HWTC7F90699E",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-57",
         "codigo":"000",
         "descripcion":"EXITO"
      },
      "par58":{
         "telefono":"6865659510",
         "estadoOperativo":"Up",
         "estadoAdministrativo":"Up",
         "potenciaOptica":-26.990000000000002,
         "clasificacionPotencia":"Parametros en limite",
         "vlan":"1759",
         "serieModem":"HWTC7F04B69E",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-58",
         "codigo":"000",
         "descripcion":"EXITO"
      },
      "par59":{
         "telefono":"6865545100",
         "estadoOperativo":"Down",
         "estadoAdministrativo":"Up",
         "potenciaOptica":"",
         "clasificacionPotencia":"Parametro fuera de rango",
         "vlan":"1759",
         "serieModem":"SCOM207C7E84",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-59",
         "codigo":"000",
         "descripcion":"EXITO"
      },
      "par60":{
         "telefono":"6865543672",
         "estadoOperativo":"Down",
         "estadoAdministrativo":"Up",
         "potenciaOptica":"",
         "clasificacionPotencia":"Parametro fuera de rango",
         "vlan":"1759",
         "serieModem":"SCOM201032FB",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-60",
         "codigo":"000",
         "descripcion":"EXITO"
      },
      "par61":{
         "telefono":"6865546572",
         "estadoOperativo":"Up",
         "estadoAdministrativo":"Up",
         "potenciaOptica":-19.830000000000002,
         "clasificacionPotencia":"Buena recepcion",
         "vlan":"1759",
         "serieModem":"HWTC933A269E",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-61",
         "codigo":"000",
         "descripcion":"EXITO"
      },
      "par62":{
         "telefono":"6865547203",
         "estadoOperativo":"Up",
         "estadoAdministrativo":"Up",
         "potenciaOptica":-26.990000000000002,
         "clasificacionPotencia":"Parametros en limite",
         "vlan":"1759",
         "serieModem":"HWTC9302559E",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-62",
         "codigo":"000",
         "descripcion":"EXITO"
      },
      "par63":{
         "telefono":"6865544692",
         "estadoOperativo":"Up",
         "estadoAdministrativo":"Up",
         "potenciaOptica":-18.120000000000001,
         "clasificacionPotencia":"Buena recepcion",
         "vlan":"1759",
         "serieModem":"HWTC54E8549E",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-63",
         "codigo":"000",
         "descripcion":"EXITO"
      },
      "par64":{
         "telefono":"",
         "estadoOperativo":"Down",
         "estadoAdministrativo":"Down",
         "potenciaOptica":"",
         "clasificacionPotencia":"Parametro fuera de rango",
         "vlan":"",
         "serieModem":"",
         "dropID":"BCNGGONZALEZORTEG-02:0-0-17-6-64",
         "codigo":"000",
         "descripcion":"EXITO"
      }
   }
    }`;

    const data = JSON.parse(matrixData);
    const respuesta = data.Respuesta || {};

    const terminal = respuesta.terminal || '';
    const terminalPrefix = terminal.includes("FO") ? terminal.substring(0, terminal.indexOf("FO") + 2) : terminal;
    const terminalSuffix = terminal.includes("FO") ? terminal.split("FO")[1] : '';

    document.getElementById("table-title").textContent = `Terminal: ${terminalPrefix}`;
    document.getElementById("test-info").innerHTML = `
        <p><strong>Fecha de Inicio:</strong> ${respuesta.fechaInicio || 'N/A'}</p>
    `;

    const headerRow = document.getElementById("column-header");
    const valueRow = document.getElementById("potencia-row");
    valueRow.innerHTML = `<td><strong>${terminalSuffix || 'â€”'}</strong></td>`;

    const potenciaColor = (clasificacion) => {
        const value = (clasificacion || '').toLowerCase();
        if (value.includes('buena')) return 'ok';
        if (value.includes('limite')) return 'warn';
        if (value.includes('fuera')) return 'low';
        return 'empty';
    };

    const showModal = (par) => {
        const modal = document.getElementById("info-modal");
        const body = document.getElementById("modal-body");

        body.innerHTML = `
            <p><strong>ðŸ“ž TelÃ©fono:</strong> ${par.telefono || 'â€”'}</p>
            <p><strong>ðŸ“¶ Estado Operativo:</strong> ${par.estadoOperativo || 'â€”'}</p>
            <p><strong>ðŸ›  Estado Administrativo:</strong> ${par.estadoAdministrativo || 'â€”'}</p>
            <p><strong>ðŸ”¦ Potencia Ã“ptica:</strong> ${par.potenciaOptica || 'â€”'}</p>
            <p><strong>âš™ ClasificaciÃ³n:</strong> ${par.clasificacionPotencia || 'â€”'}</p>
            <p><strong>ðŸ›œ VLAN:</strong> ${par.vlan || 'â€”'}</p>
            <p><strong>ðŸ”§ Serie MÃ³dem:</strong> ${par.serieModem || 'â€”'}</p>
            <p><strong>ðŸ§µ Drop ID:</strong> ${par.dropID || 'â€”'}</p>
            <p><strong>ðŸ§¾ CÃ³digo:</strong> ${par.codigo || 'â€”'}</p>
            <p><strong>ðŸ“‹ DescripciÃ³n:</strong> ${par.descripcion || 'â€”'}</p>
        `;

        modal.style.display = 'flex';
    };

    const parKeys = Object.keys(respuesta)
        .filter(k => /^par\d+$/i.test(k))
        .sort((a, b) => parseInt(a.replace('par', '')) - parseInt(b.replace('par', '')));

    parKeys.forEach((parKey, index) => {
        const par = respuesta[parKey];
        const potencia = par.potenciaOptica;
        let displayValue = potencia;
        if (potencia !== '' && !isNaN(potencia)) {
            displayValue = parseFloat(potencia).toFixed(2);
        }

        const th = document.createElement("th");
        th.textContent = index + 1;
        headerRow.appendChild(th);

        const td = document.createElement("td");
        td.textContent = displayValue || 'â€”';
        td.className = potenciaColor(par.clasificacionPotencia);
        td.addEventListener("click", () => showModal(par));
        valueRow.appendChild(td);
    });

    window.onclick = function(event) {
        const modal = document.getElementById('info-modal');
        if (event.target === modal) {
            modal.style.display = "none";
        }
    };
</script>

</body>
</html>
